define(["./when-b60132fc","./buildModuleUrl-8cce5713","./ArcType-f8a754c5","./arrayFill-4513d7ad","./BoundingRectangle-f7aac99a","./Cartesian4-b0ddc4ba","./Check-7b2a090c","./FeatureDetection-ab6f364c","./EllipsoidGeodesic-1bbae6bf","./PolygonPipeline-f2f37e26","./GeometryAttribute-923c2729","./PolygonGeometryLibrary-34d6c185","./GeometryOffsetAttribute-fbeb6f1a","./GeometryPipeline-54076c24","./IndexDatatype-3565e02d","./Math-31e539c2","./VertexFormat-6446fca0","./WebGLConstants-aba9fc67","./Plane-5716a082","./earcut-2.2.1-20c8012f","./EllipsoidRhumbLine-3ee4574a","./GeometryAttributes-252e9929","./AttributeCompression-399750a1","./EncodedCartesian3-ac3717ed"],(function(e,t,r,a,o,i,n,s,l,u,c,p,y,g,d,m,h,f,b,v,_,P,x,w){"use strict";var T=new i.Cartographic,A=new i.Cartographic;function C(e,t,r,a){var o=a.cartesianToCartographic(e,T).height,i=a.cartesianToCartographic(t,A);i.height=o,a.cartographicToCartesian(i,t);var n=a.cartesianToCartographic(r,A);n.height=o-100,a.cartographicToCartesian(n,r)}var E=new o.BoundingRectangle,I=new i.Cartesian3,G=new i.Cartesian3,V=new i.Cartesian3,F=new i.Cartesian3,N=new i.Cartesian3,H=new i.Cartesian3,D=new i.Cartesian3,O=new i.Cartesian3,R=new i.Cartesian3,L=new t.Cartesian2,M=new t.Cartesian2,S=new i.Cartesian3,B=new c.Quaternion,k=new t.Matrix3,z=new t.Matrix3;function Y(r){var o=r.vertexFormat,n=r.geometry,l=r.shadowVolume,u=n.attributes.position.values,p=u.length,g=r.wall,d=r.top||g,h=r.bottom||g;if(o.st||o.normal||o.tangent||o.bitangent||l){var f=r.boundingRectangle,b=r.tangentPlane,v=r.ellipsoid,_=r.stRotation,P=r.perPositionHeight,x=L;x.x=f.x,x.y=f.y;var w,T=o.st?new Float32Array(p/3*2):void 0;o.normal&&(w=P&&d&&!g?n.attributes.normal.values:new Float32Array(p));var A=o.tangent?new Float32Array(p):void 0,E=o.bitangent?new Float32Array(p):void 0,Y=l?new Float32Array(p):void 0,U=0,W=0,j=G,Q=V,q=F,K=!0,Z=k,J=z;if(0!==_){var X=c.Quaternion.fromAxisAngle(b._plane.normal,_,B);Z=t.Matrix3.fromQuaternion(X,Z),X=c.Quaternion.fromAxisAngle(b._plane.normal,-_,B),J=t.Matrix3.fromQuaternion(X,J)}else Z=t.Matrix3.clone(t.Matrix3.IDENTITY,Z),J=t.Matrix3.clone(t.Matrix3.IDENTITY,J);var $=0,ee=0;d&&h&&($=p/2,ee=p/3,p/=2);for(var te=0;te<p;te+=3){var re=i.Cartesian3.fromArray(u,te,S);if(o.st){var ae=t.Matrix3.multiplyByVector(Z,re,I);ae=v.scaleToGeodeticSurface(ae,ae);var oe=b.projectPointOntoPlane(ae,M);t.Cartesian2.subtract(oe,x,oe);var ie=m.Math3D.clamp(oe.x/f.width,0,1),ne=m.Math3D.clamp(oe.y/f.height,0,1);h&&(T[U+ee]=ie,T[U+1+ee]=ne),d&&(T[U]=ie,T[U+1]=ne),U+=2}if(o.normal||o.tangent||o.bitangent||l){var se=W+1,le=W+2;if(g){if(te+3<p){var ue=i.Cartesian3.fromArray(u,te+3,N);if(K){var ce=i.Cartesian3.fromArray(u,te+p,H);P&&C(re,ue,ce,v),i.Cartesian3.subtract(ue,re,ue),i.Cartesian3.subtract(ce,re,ce),j=i.Cartesian3.normalize(i.Cartesian3.cross(ce,ue,j),j),K=!1}i.Cartesian3.equalsEpsilon(ue,re,m.Math3D.EPSILON10)&&(K=!0)}(o.tangent||o.bitangent)&&(q=v.geodeticSurfaceNormal(re,q),o.tangent&&(Q=i.Cartesian3.normalize(i.Cartesian3.cross(q,j,Q),Q)))}else j=v.geodeticSurfaceNormal(re,j),(o.tangent||o.bitangent)&&(P&&(D=i.Cartesian3.fromArray(w,W,D),O=i.Cartesian3.cross(i.Cartesian3.UNIT_Z,D,O),O=i.Cartesian3.normalize(t.Matrix3.multiplyByVector(J,O,O),O),o.bitangent&&(R=i.Cartesian3.normalize(i.Cartesian3.cross(D,O,R),R))),Q=i.Cartesian3.cross(i.Cartesian3.UNIT_Z,j,Q),Q=i.Cartesian3.normalize(t.Matrix3.multiplyByVector(J,Q,Q),Q),o.bitangent&&(q=i.Cartesian3.normalize(i.Cartesian3.cross(j,Q,q),q)));o.normal&&(r.wall?(w[W+$]=j.x,w[se+$]=j.y,w[le+$]=j.z):h&&(w[W+$]=-j.x,w[se+$]=-j.y,w[le+$]=-j.z),(d&&!P||g)&&(w[W]=j.x,w[se]=j.y,w[le]=j.z)),l&&(g&&(j=v.geodeticSurfaceNormal(re,j)),Y[W+$]=-j.x,Y[se+$]=-j.y,Y[le+$]=-j.z),o.tangent&&(r.wall?(A[W+$]=Q.x,A[se+$]=Q.y,A[le+$]=Q.z):h&&(A[W+$]=-Q.x,A[se+$]=-Q.y,A[le+$]=-Q.z),d&&(P?(A[W]=O.x,A[se]=O.y,A[le]=O.z):(A[W]=Q.x,A[se]=Q.y,A[le]=Q.z))),o.bitangent&&(h&&(E[W+$]=q.x,E[se+$]=q.y,E[le+$]=q.z),d&&(P?(E[W]=R.x,E[se]=R.y,E[le]=R.z):(E[W]=q.x,E[se]=q.y,E[le]=q.z))),W+=3}}o.st&&(n.attributes.st=new c.GeometryAttribute({componentDatatype:s.ComponentDatatype.FLOAT,componentsPerAttribute:2,values:T})),o.normal&&(n.attributes.normal=new c.GeometryAttribute({componentDatatype:s.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:w})),o.tangent&&(n.attributes.tangent=new c.GeometryAttribute({componentDatatype:s.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:A})),o.bitangent&&(n.attributes.bitangent=new c.GeometryAttribute({componentDatatype:s.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:E})),l&&(n.attributes.extrudeDirection=new c.GeometryAttribute({componentDatatype:s.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:Y}))}if(r.extrude&&e.defined(r.offsetAttribute)){var pe=u.length/3,ye=new Uint8Array(pe);if(r.offsetAttribute===y.GeometryOffsetAttribute.TOP)d&&h||g?ye=a.arrayFill(ye,1,0,pe/2):d&&(ye=a.arrayFill(ye,1));else{var ge=r.offsetAttribute===y.GeometryOffsetAttribute.NONE?0:1;ye=a.arrayFill(ye,ge)}n.attributes.applyOffset=new c.GeometryAttribute({componentDatatype:s.ComponentDatatype.UNSIGNED_BYTE,componentsPerAttribute:1,values:ye})}return n}var U=new i.Cartographic,W=new i.Cartographic,j={west:0,east:0},Q=new l.EllipsoidGeodesic;function q(a,o,i,n,s){if(s=e.defaultValue(s,new t.Rectangle),!e.defined(a)||a.length<3)return s.west=0,s.north=0,s.south=0,s.east=0,s;if(i===r.ArcType.RHUMB)return t.Rectangle.fromCartesianArray(a,o,s);Q.ellipsoid.equals(o)||(Q=new l.EllipsoidGeodesic(void 0,void 0,o)),s.west=Number.POSITIVE_INFINITY,s.east=Number.NEGATIVE_INFINITY,s.south=Number.POSITIVE_INFINITY,s.north=Number.NEGATIVE_INFINITY,j.west=Number.POSITIVE_INFINITY,j.east=Number.NEGATIVE_INFINITY;for(var u,c=1/m.Math3D.chordLength(n,o.maximumRadius),p=a.length,y=o.cartesianToCartographic(a[0],W),g=U,d=1;d<p;d++)u=g,g=y,y=o.cartesianToCartographic(a[d],u),Q.setEndPoints(g,y),Z(Q,c,s,j);return u=g,g=y,y=o.cartesianToCartographic(a[0],u),Q.setEndPoints(g,y),Z(Q,c,s,j),s.east-s.west>j.west-j.east&&(s.east=j.east,s.west=j.west),s}var K=new i.Cartographic;function Z(e,t,r,a){for(var o=e.surfaceDistance,i=Math.ceil(o*t),n=i>0?o/(i-1):Number.POSITIVE_INFINITY,s=0,l=0;l<i;l++){var u=e.interpolateUsingSurfaceDistance(s,K);s+=n;var c=u.longitude,p=u.latitude;r.west=Math.min(r.west,c),r.east=Math.max(r.east,c),r.south=Math.min(r.south,p),r.north=Math.max(r.north,p),a.west=c>0?Math.min(c,a.west):a.west,a.east=c<0?Math.max(c,a.east):a.east}}var J=[];function X(e,t,r,a,o,i,n,s,l,c){var y,g={walls:[]};if(i||n){var m,h,f=p.PolygonGeometryLibrary.createGeometryFromPositions(e,t,r,o,s,l),b=f.attributes.position.values,v=f.indices;if(i&&n){var _=b.concat(b);m=_.length/3,(h=d.IndexDatatype.createTypedArray(m,2*v.length)).set(v);var P=v.length,x=m/2;for(y=0;y<P;y+=3){var w=h[y]+x,T=h[y+1]+x,A=h[y+2]+x;h[y+P]=A,h[y+1+P]=T,h[y+2+P]=w}if(f.attributes.position.values=_,o&&s.normal){var C=f.attributes.normal.values;f.attributes.normal.values=new Float32Array(_.length),f.attributes.normal.values.set(C)}f.indices=h}else if(n){for(m=b.length/3,h=d.IndexDatatype.createTypedArray(m,v.length),y=0;y<v.length;y+=3)h[y]=v[y+2],h[y+1]=v[y+1],h[y+2]=v[y];f.indices=h}g.topAndBottom=new p.GeometryInstance({geometry:f})}var E,I=a.outerRing,G=u.EllipsoidTangentPlane.fromPoints(I,e),V=G.projectPointsOntoPlane(I,J),F=u.PolygonPipeline.computeWindingOrder2D(V);F===u.WindingOrder.CLOCKWISE&&(I=I.slice().reverse()),c&&(E=p.PolygonGeometryLibrary.computeWallGeometry(I,e,r,o,l),g.walls.push(new p.GeometryInstance({geometry:E})));var N=a.holes;for(y=0;y<N.length;y++){var H=N[y];V=(G=u.EllipsoidTangentPlane.fromPoints(H,e)).projectPointsOntoPlane(H,J),(F=u.PolygonPipeline.computeWindingOrder2D(V))===u.WindingOrder.COUNTER_CLOCKWISE&&(H=H.slice().reverse()),E=p.PolygonGeometryLibrary.computeWallGeometry(H,e,r,o,l),g.walls.push(new p.GeometryInstance({geometry:E}))}return g}function $(a){var o=a.polygonHierarchy,i=e.defaultValue(a.vertexFormat,h.VertexFormat.DEFAULT),n=e.defaultValue(a.ellipsoid,t.Ellipsoid.WGS84),s=e.defaultValue(a.granularity,m.Math3D.RADIANS_PER_DEGREE),l=e.defaultValue(a.stRotation,0),u=e.defaultValue(a.perPositionHeight,!1),c=u&&e.defined(a.extrudedHeight),y=e.defaultValue(a.height,0),g=e.defaultValue(a.extrudedHeight,y);if(!c){var d=Math.max(y,g);g=Math.min(y,g),y=d}this._vertexFormat=h.VertexFormat.clone(i),this._ellipsoid=t.Ellipsoid.clone(n),this._granularity=s,this._stRotation=l,this._height=y,this._extrudedHeight=g,this._closeTop=e.defaultValue(a.closeTop,!0),this._closeBottom=e.defaultValue(a.closeBottom,!0),this._extrudeOutering=e.defaultValue(a.extrudeOutering,!0),this._polygonHierarchy=o,this._perPositionHeight=u,this._perPositionHeightExtrude=c,this._shadowVolume=e.defaultValue(a.shadowVolume,!1),this._workerName="createPolygonGeometry",this._offsetAttribute=a.offsetAttribute,this._arcType=e.defaultValue(a.arcType,r.ArcType.GEODESIC),this._rectangle=void 0,this._textureCoordinateRotationPoints=void 0,this.packedLength=p.PolygonGeometryLibrary.computeHierarchyPackedLength(o)+t.Ellipsoid.packedLength+h.VertexFormat.packedLength+12}$.fromPositions=function(t){return new $({polygonHierarchy:{positions:(t=e.defaultValue(t,e.defaultValue.EMPTY_OBJECT)).positions},height:t.height,extrudedHeight:t.extrudedHeight,vertexFormat:t.vertexFormat,stRotation:t.stRotation,ellipsoid:t.ellipsoid,granularity:t.granularity,perPositionHeight:t.perPositionHeight,closeTop:t.closeTop,closeBottom:t.closeBottom,offsetAttribute:t.offsetAttribute,arcType:t.arcType})},$.pack=function(r,a,o){return o=e.defaultValue(o,0),o=p.PolygonGeometryLibrary.packPolygonHierarchy(r._polygonHierarchy,a,o),t.Ellipsoid.pack(r._ellipsoid,a,o),o+=t.Ellipsoid.packedLength,h.VertexFormat.pack(r._vertexFormat,a,o),o+=h.VertexFormat.packedLength,a[o++]=r._height,a[o++]=r._extrudedHeight,a[o++]=r._granularity,a[o++]=r._stRotation,a[o++]=r._perPositionHeightExtrude?1:0,a[o++]=r._perPositionHeight?1:0,a[o++]=r._closeTop?1:0,a[o++]=r._closeBottom?1:0,a[o++]=r._shadowVolume?1:0,a[o++]=e.defaultValue(r._offsetAttribute,-1),a[o++]=r._arcType,a[o]=r.packedLength,a};var ee=t.Ellipsoid.clone(t.Ellipsoid.UNIT_SPHERE),te=new h.VertexFormat,re={polygonHierarchy:{}};return $.unpack=function(r,a,o){a=e.defaultValue(a,0);var i=p.PolygonGeometryLibrary.unpackPolygonHierarchy(r,a);a=i.startingIndex,delete i.startingIndex;var n=t.Ellipsoid.unpack(r,a,ee);a+=t.Ellipsoid.packedLength;var s=h.VertexFormat.unpack(r,a,te);a+=h.VertexFormat.packedLength;var l=r[a++],u=r[a++],c=r[a++],y=r[a++],g=1===r[a++],d=1===r[a++],m=1===r[a++],f=1===r[a++],b=1===r[a++],v=r[a++],_=r[a++],P=r[a];return e.defined(o)||(o=new $(re)),o._polygonHierarchy=i,o._ellipsoid=t.Ellipsoid.clone(n,o._ellipsoid),o._vertexFormat=h.VertexFormat.clone(s,o._vertexFormat),o._height=l,o._extrudedHeight=u,o._granularity=c,o._stRotation=y,o._perPositionHeightExtrude=g,o._perPositionHeight=d,o._closeTop=m,o._closeBottom=f,o._shadowVolume=b,o._offsetAttribute=-1===v?void 0:v,o._arcType=_,o.packedLength=P,o},$.computeRectangle=function(a,o){var i=e.defaultValue(a.granularity,m.Math3D.RADIANS_PER_DEGREE),n=e.defaultValue(a.arcType,r.ArcType.GEODESIC),s=a.polygonHierarchy,l=e.defaultValue(a.ellipsoid,t.Ellipsoid.WGS84);return q(s.positions,l,n,i,o)},$.createGeometry=function(r){var o=r._vertexFormat,i=r._ellipsoid,n=r._granularity,l=r._stRotation,h=r._polygonHierarchy,f=r._perPositionHeight,b=r._closeTop,v=r._closeBottom,_=r._arcType,P=h.positions;if(!(P.length<3)){var x=u.EllipsoidTangentPlane.fromPoints(P,i),w=p.PolygonGeometryLibrary.polygonsFromHierarchy(h,x.projectPointsOntoPlane.bind(x),!f,i),T=w.hierarchy,A=w.polygons;if(0!==T.length){P=T[0].outerRing;var C,I=p.PolygonGeometryLibrary.computeBoundingRectangle(x.plane.normal,x.projectPointOntoPlane.bind(x),P,l,E),G=[],V=r._height,F=r._extrudedHeight,N={perPositionHeight:f,vertexFormat:o,geometry:void 0,tangentPlane:x,boundingRectangle:I,ellipsoid:i,stRotation:l,bottom:!1,top:!0,wall:!1,extrude:!1,arcType:_};if(r._perPositionHeightExtrude||!m.Math3D.equalsEpsilon(V,F,0,m.Math3D.EPSILON2))for(N.extrude=!0,N.top=b,N.bottom=v,N.shadowVolume=r._shadowVolume,N.offsetAttribute=r._offsetAttribute,C=0;C<A.length;C++){var H,D=X(i,A[C],n,T[C],f,b,v,o,_,r._extrudeOutering);b&&v?(H=D.topAndBottom,N.geometry=p.PolygonGeometryLibrary.scaleToGeodeticHeightExtruded(H.geometry,V,F,i,f)):b?((H=D.topAndBottom).geometry.attributes.position.values=u.PolygonPipeline.scaleToGeodeticHeight(H.geometry.attributes.position.values,V,i,!f),N.geometry=H.geometry):v&&((H=D.topAndBottom).geometry.attributes.position.values=u.PolygonPipeline.scaleToGeodeticHeight(H.geometry.attributes.position.values,F,i,!0),N.geometry=H.geometry),(b||v)&&(N.wall=!1,H.geometry=Y(N),G.push(H));var O=D.walls;N.wall=!0;for(var R=0;R<O.length;R++){var L=O[R];N.geometry=p.PolygonGeometryLibrary.scaleToGeodeticHeightExtruded(L.geometry,V,F,i,f),L.geometry=Y(N),G.push(L)}}else for(C=0;C<A.length;C++){var M=new p.GeometryInstance({geometry:p.PolygonGeometryLibrary.createGeometryFromPositions(i,A[C],n,f,o,_)});if(M.geometry.attributes.position.values=u.PolygonPipeline.scaleToGeodeticHeight(M.geometry.attributes.position.values,V,i,!f),N.geometry=M.geometry,M.geometry=Y(N),e.defined(r._offsetAttribute)){var S=M.geometry.attributes.position.values.length,B=new Uint8Array(S/3),k=r._offsetAttribute===y.GeometryOffsetAttribute.NONE?0:1;a.arrayFill(B,k),M.geometry.attributes.applyOffset=new c.GeometryAttribute({componentDatatype:s.ComponentDatatype.UNSIGNED_BYTE,componentsPerAttribute:1,values:B})}G.push(M)}var z=g.GeometryPipeline.combineInstances(G)[0];z.attributes.position.values=new Float64Array(z.attributes.position.values),z.indices=d.IndexDatatype.createTypedArray(z.attributes.position.values.length/3,z.indices);var U=z.attributes,W=t.BoundingSphere.fromVertices(U.position.values);return o.position||delete U.position,new c.Geometry({attributes:U,indices:z.indices,primitiveType:z.primitiveType,boundingSphere:W,offsetAttribute:r._offsetAttribute})}}},$.createShadowVolume=function(e,t,r){var a=e._granularity,o=e._ellipsoid,i=t(a,o),n=r(a,o);return new $({polygonHierarchy:e._polygonHierarchy,ellipsoid:o,stRotation:e._stRotation,granularity:a,perPositionHeight:!1,extrudedHeight:i,height:n,vertexFormat:h.VertexFormat.POSITION_ONLY,shadowVolume:!0,arcType:e._arcType})},Object.defineProperties($.prototype,{rectangle:{get:function(){if(!e.defined(this._rectangle)){var t=this._polygonHierarchy.positions;this._rectangle=q(t,this._ellipsoid,this._arcType,this._granularity)}return this._rectangle}},textureCoordinateRotationPoints:{get:function(){return e.defined(this._textureCoordinateRotationPoints)||(this._textureCoordinateRotationPoints=function(e){var t=-e._stRotation;if(0===t)return[0,0,0,1,1,0];var r=e._ellipsoid,a=e._polygonHierarchy.positions,o=e.rectangle;return c.Geometry._textureCoordinateRotationPoints(a,t,r,o)}(this)),this._textureCoordinateRotationPoints}}}),function(r,a){return e.defined(a)&&(r=$.unpack(r,a)),r._ellipsoid=t.Ellipsoid.clone(r._ellipsoid),$.createGeometry(r)}}));
